<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>僑港順德龍山同鄉會 - 智能發文系統</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: "Microsoft YaHei", sans-serif; background: #e0e0e0; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
    
    /* 控制面板 */
    .control-panel { background: white; padding: 20px; border-radius: 8px; width: 100%; max-width: 794px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); box-sizing: border-box; }
    .input-group { margin-bottom: 12px; }
    label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 14px; }
    input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
    .btn-main { background: #c00; color: white; border: none; padding: 15px; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; }
    
    /* A4 畫布通用樣式 */
    .a4-page { 
        background: white; 
        width: 794px; 
        height: 1123px; /* A4 標準高度 */
        box-sizing: border-box; 
        display: flex; 
        flex-direction: column; 
        position: relative; 
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        overflow: hidden; /* 隱藏溢出，交由JS處理 */
    }
    
    /* 第二頁預設隱藏 */
    #canvas-area-2 { display: none; }

    .header-wrapper { border-bottom: 2px solid #c00; width: 100%; margin-bottom: 5px; flex-shrink: 0; }
    .header-img { width: 100%; display: block; }
    
    .paper-content { padding: 40px 80px; flex: 1; display: flex; flex-direction: column; }
    
    .doc-title { font-size: 32px; font-weight: bold; text-align: center; margin-bottom: 40px; line-height: 1.5; flex-shrink: 0; }
    
    /* 送達單位 */
    .doc-recipient { font-size: 20px; line-height: 1.8; margin-bottom: 10px; text-indent: 0; position: relative; z-index: 5; flex-shrink: 0; }
    
    /* 正文 */
    .doc-body { font-size: 20px; line-height: 1.8; white-space: pre-wrap; text-indent: 2em; margin-bottom: 30px; position: relative; z-index: 5; }
    
    /* 敬語 */
    .doc-salutation { font-size: 20px; padding-left: 2em; margin-bottom: 20px; position: relative; z-index: 5; flex-shrink: 0; }
    
    /* 落款區域 */
    .signature-container { align-self: flex-end; display: flex; flex-direction: column; align-items: center; min-width: 250px; position: relative; margin-top: auto; padding-bottom: 60px; flex-shrink: 0; }
    .sig-name, .sig-date { position: relative; z-index: 10; font-weight: normal; } 
    .sig-name { font-size: 22px; margin-bottom: 8px; }
    .sig-date { font-size: 18px; }
    
    /* 印章樣式 */
    .seal-img { 
      display: none; 
      position: absolute; 
      width: 150px; 
      height: 150px; 
      top: -35px; 
      left: 50%; 
      transform: translateX(-50%); 
      opacity: 0.9; 
      z-index: 1; 
      pointer-events: none; 
    }

    /* 結果展示區 */
    #result-container { margin-top: 30px; text-align: center; display: none; padding-bottom: 100px; width: 100%; max-width: 794px; }
    .result-img-wrapper { margin-bottom: 20px; }
    .result-img-wrapper img { width: 100%; border: 1px solid #999; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .page-label { font-weight: bold; color: #555; margin-bottom: 5px; display: block; }
    
    .seal-control-panel { background: #fff; padding: 20px; border-radius: 8px; border: 2px solid #c00; margin-bottom: 20px; }
  </style>
</head>
<body onload="setCurrentDate()">

<div class="control-panel">
  <div class="input-group"><label>公文標題</label><input type="text" id="input-title"></div>
  <div class="input-group"><label>送達單位 (如：某某委員會)</label><input type="text" id="input-recipient" placeholder="請輸入收件方名稱"></div>
  <div class="input-group"><label>正文內容</label><textarea id="input-content" rows="10" placeholder="內容過長時將自動分頁"></textarea></div>
  <div class="input-group"><label>敬語</label><input type="text" id="input-salutation" value="此致"></div>
  <div class="input-group"><label>署名</label><input type="text" id="input-name"></div>
  <div class="input-group"><label>日期</label><input type="text" id="input-date"></div>
  <button id="main-btn" class="btn-main" onclick="generatePreview()">生成預覽並記錄</button>
</div>

<div id="preview-wrapper">
    <div id="canvas-area-1" class="a4-page">
      <div class="header-wrapper">
        <img class="header-img" src="data:image/png;base64,YOUR_HEADER_BASE64">
      </div>
      <div class="paper-content" id="content-container-1">
        <div class="doc-title" id="show-title-1"></div>
        <div class="doc-recipient" id="show-recipient-1"></div>
        <div class="doc-body" id="show-body-1"></div>
        
        <div class="doc-salutation" id="show-salutation-1"></div>
        <div class="signature-container" id="sig-container-1">
          <img class="seal-img" id="doc-seal-1" src="data:image/png;base64,YOUR_SEAL_BASE64">
          <div class="sig-name" id="show-name-1"></div>
          <div class="sig-date" id="show-date-1"></div>
        </div>
      </div>
    </div>

    <div id="canvas-area-2" class="a4-page">
        <div class="header-wrapper">
            <img class="header-img" src="data:image/png;base64,YOUR_HEADER_BASE64">
        </div>
        <div class="paper-content" id="content-container-2">
            <div class="doc-body" id="show-body-2" style="margin-top: 20px;"></div>
            
            <div class="doc-salutation" id="show-salutation-2"></div>
            <div class="signature-container" id="sig-container-2">
                <img class="seal-img" id="doc-seal-2" src="data:image/png;base64,YOUR_SEAL_BASE64">
                <div class="sig-name" id="show-name-2"></div>
                <div class="sig-date" id="show-date-2"></div>
            </div>
        </div>
    </div>
</div>

<div id="result-container">
  <div class="seal-control-panel">
    <h3>第一步：檢查預覽</h3>
    <p>內容無誤後，輸入密碼加蓋公章 (若有兩頁將蓋在最後一頁)：</p>
    <div style="display:flex; gap:10px; justify-content:center;">
        <input type="password" id="seal-pw" placeholder="輸入蓋章密碼" style="width:200px;">
        <button onclick="applySealAndRegen()" style="padding:10px 20px; background:#c00; color:white; border:none; border-radius:4px; cursor:pointer;">加蓋公章</button>
    </div>
  </div>
  
  <div id="result-images-area"></div>
</div>

<script>
function setCurrentDate() {
    const now = new Date();
    document.getElementById('input-date').value = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日`;
}

// 全局變量存儲是否需要兩頁
let isMultiPage = false;

async function generatePreview() {
    // 1. 重置狀態：隱藏第二頁，清空第二頁內容，隱藏所有印章
    document.getElementById('canvas-area-2').style.display = "none";
    document.getElementById('doc-seal-1').style.display = "none";
    document.getElementById('doc-seal-2').style.display = "none";
    isMultiPage = false;

    // 2. 獲取原始數據
    const title = document.getElementById('input-title').value;
    const recipient = document.getElementById('input-recipient').value;
    const bodyText = document.getElementById('input-content').value;
    const salutation = document.getElementById('input-salutation').value;
    const name = document.getElementById('input-name').value;
    const dateStr = document.getElementById('input-date').value;

    // 3. 先嘗試將所有內容放入第一頁
    document.getElementById('show-title-1').innerText = title;
    document.getElementById('show-recipient-1').innerText = recipient ? recipient + "：" : "";
    document.getElementById('show-body-1').innerText = bodyText;
    document.getElementById('show-body-2').innerText = ""; // 清空第二頁正文

    // 將敬語和落款還原到第一頁
    restoreToPage1(salutation, name, dateStr);

    // 4. 【核心邏輯】檢測高度溢出並分頁
    const page1 = document.getElementById('canvas-area-1');
    const MAX_HEIGHT = 1080; // A4 高度 1123px，留一點緩衝

    // 如果第一頁高度超過限制
    if (page1.scrollHeight > MAX_HEIGHT) {
        isMultiPage = true;
        document.getElementById('canvas-area-2').style.display = "flex"; // 啟用第二頁
        
        // 策略 A: 先試著把落款和敬語移到第二頁
        moveToPage2(salutation, name, dateStr);
        
        // 再次檢查第一頁高度，如果還是溢出，說明正文太長，需要拆分正文
        if (page1.scrollHeight > MAX_HEIGHT) {
           splitBodyText(bodyText, page1, MAX_HEIGHT);
        }
    }

    // 5. 記錄數據
    logToGAS();

    // 6. 生成圖片
    await renderImages("預覽圖片 (未蓋章)");
}

// 輔助函數：將落款移回第一頁
function restoreToPage1(salutation, name, dateStr) {
    document.getElementById('show-salutation-1').innerText = salutation;
    document.getElementById('show-salutation-1').style.display = "block";
    document.getElementById('sig-container-1').style.display = "flex";
    document.getElementById('show-name-1').innerText = name;
    document.getElementById('show-date-1').innerText = dateStr;

    // 隱藏第二頁的這些元素
    document.getElementById('show-salutation-2').style.display = "none";
    document.getElementById('sig-container-2').style.display = "none";
}

// 輔助函數：將落款移到第二頁
function moveToPage2(salutation, name, dateStr) {
    // 隱藏第一頁的落款
    document.getElementById('show-salutation-1').style.display = "none";
    document.getElementById('sig-container-1').style.display = "none";

    // 顯示第二頁的落款
    document.getElementById('show-salutation-2').innerText = salutation;
    document.getElementById('show-salutation-2').style.display = "block";
    
    document.getElementById('sig-container-2').style.display = "flex";
    document.getElementById('show-name-2').innerText = name;
    document.getElementById('show-date-2').innerText = dateStr;
}

// 【核心算法】二分法拆分正文
function splitBodyText(fullText, pageElement, maxHeight) {
    let left = 0;
    let right = fullText.length;
    let splitIndex = fullText.length;

    // 二分查找：找到第一頁能容納的最大字數
    // 為了性能，我們簡單地嘗試，實際應用中這種方式對瀏覽器壓力尚可
    // 更高效的方式是估算行高，但這裡用DOM檢測最準確
    
    const body1 = document.getElementById('show-body-1');
    const body2 = document.getElementById('show-body-2');

    while (left <= right) {
        let mid = Math.floor((left + right) / 2);
        body1.innerText = fullText.substring(0, mid) + "..."; // 嘗試放入前 mid 個字
        
        if (pageElement.scrollHeight <= maxHeight) {
            splitIndex = mid;
            left = mid + 1; // 嘗試更多字
        } else {
            right = mid - 1; // 減少字數
        }
    }

    // 最終拆分
    // 第一頁放前半部分
    body1.innerText = fullText.substring(0, splitIndex);
    // 第二頁放後半部分 (可以加個接上頁的提示，這裡暫不加)
    body2.innerText = fullText.substring(splitIndex);
}

// 蓋章並重新生成
async function applySealAndRegen() {
    if (document.getElementById('seal-pw').value === "8888") {
        // 根據是否分頁，決定印章蓋在哪一頁
        if (isMultiPage) {
            document.getElementById('doc-seal-2').style.display = "block";
        } else {
            document.getElementById('doc-seal-1').style.display = "block";
        }
        await renderImages("正式公文 (已蓋章)");
        alert("公章已加蓋！");
    } else {
        alert("密碼錯誤。");
    }
}

async function renderImages(statusText) {
    const resultArea = document.getElementById('result-images-area');
    resultArea.innerHTML = `<h3 style='color:#c00'>${statusText}</h3>`;
    document.getElementById('result-container').style.display = "block";

    // 截取第一頁
    const canvas1 = await html2canvas(document.querySelector("#canvas-area-1"), {scale: 2, useCORS: true, backgroundColor: "#ffffff"});
    const img1 = document.createElement("img");
    img1.src = canvas1.toDataURL("image/png");
    
    const wrapper1 = document.createElement("div");
    wrapper1.className = "result-img-wrapper";
    wrapper1.innerHTML = "<span class='page-label'>--- 第 1 頁 ---</span>";
    wrapper1.appendChild(img1);
    resultArea.appendChild(wrapper1);

    // 如果有第二頁，截取第二頁
    if (isMultiPage) {
        const canvas2 = await html2canvas(document.querySelector("#canvas-area-2"), {scale: 2, useCORS: true, backgroundColor: "#ffffff"});
        const img2 = document.createElement("img");
        img2.src = canvas2.toDataURL("image/png");

        const wrapper2 = document.createElement("div");
        wrapper2.className = "result-img-wrapper";
        wrapper2.innerHTML = "<span class='page-label'>--- 第 2 頁 ---</span>";
        wrapper2.appendChild(img2);
        resultArea.appendChild(wrapper2);
    }
    
    document.getElementById('result-container').scrollIntoView({ behavior: 'smooth' });
}

function logToGAS() {
    const gas_url = "YOUR_GAS_URL"; 
    fetch(gas_url, {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify({ 
          title: document.getElementById('input-title').value, 
          recipient: document.getElementById('input-recipient').value, 
          user: document.getElementById('input-name').value, 
          content: document.getElementById('input-content').value 
      })
    });
}
</script>
</body>
</html>
