<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>僑港順德龍山同鄉會 - 智能發文系統</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: "Microsoft YaHei", sans-serif; background: #e0e0e0; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
    
    .control-panel { background: white; padding: 20px; border-radius: 8px; width: 100%; max-width: 794px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); box-sizing: border-box; }
    .input-group { margin-bottom: 12px; }
    label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 14px; }
    input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
    .btn-main { background: #c00; color: white; border: none; padding: 15px; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; }
    
    #canvas-wrapper { width: 794px; display: flex; flex-direction: column; }
    
    .a4-page { 
        background: white; 
        width: 794px; 
        height: 1123px; 
        box-sizing: border-box; 
        display: flex; 
        flex-direction: column; 
        position: relative; 
        overflow: hidden;
    }

    #page-2 { display: none; } /* 初始隱藏，必要時顯示 */

    .header-wrapper { border-bottom: 2px solid #c00; width: 100%; margin-bottom: 5px; }
    .header-img { width: 100%; display: block; }
    
    .paper-content { padding: 40px 80px; position: relative; flex: 1; display: flex; flex-direction: column; }
    
    .doc-title { font-size: 32px; font-weight: bold; text-align: center; margin-bottom: 30px; line-height: 1.5; }
    .doc-recipient { font-size: 20px; line-height: 1.8; margin-bottom: 10px; }
    
    /* 正文容器：現在會動態填充段落 */
    .body-container { font-size: 20px; line-height: 1.8; white-space: pre-wrap; text-indent: 2.2em; margin-bottom: 0px; }
    .doc-salutation { font-size: 20px; padding-left: 2em; margin-top: 20px; margin-bottom: 30px; }
    
    .signature-container { align-self: flex-end; display: flex; flex-direction: column; align-items: center; min-width: 250px; position: relative; }
    .sig-name { font-size: 22px; margin-bottom: 8px; z-index: 10; position: relative; }
    .sig-date { font-size: 18px; z-index: 10; position: relative; }
    
    .doc-seal { display: none; position: absolute; width: 150px; height: 150px; top: -35px; left: 50%; transform: translateX(-50%); opacity: 0.9; z-index: 1; pointer-events: none; }

    #result-container { margin-top: 30px; text-align: center; display: none; padding-bottom: 100px; width: 100%; max-width: 794px; }
    #result-image { width: 100%; border: 1px solid #999; box-shadow: 0 5px 15px rgba(0,0,0,0.3); margin-top: 20px;}
    .seal-control-panel { background: #fff; padding: 20px; border-radius: 8px; border: 2px solid #c00; margin-bottom: 20px; }
  </style>
</head>
<body onload="setCurrentDate()">

<div class="control-panel">
  <div class="input-group"><label>公文標題</label><input type="text" id="input-title" value="關於同鄉會年度大會的通知"></div>
  <div class="input-group"><label>送達單位</label><input type="text" id="input-recipient" placeholder="請輸入收件方名稱"></div>
  <div class="input-group"><label>正文內容</label><textarea id="input-content" rows="10" placeholder="輸入正文內容，內容過長將自動分至第二頁並加紅頭..."></textarea></div>
  <div class="input-group"><label>敬語</label><input type="text" id="input-salutation" value="此致"></div>
  <div class="input-group"><label>署名</label><input type="text" id="input-name"></div>
  <div class="input-group"><label>日期</label><input type="text" id="input-date"></div>
  <button class="btn-main" onclick="generatePreview()">生成預覽並記錄</button>
</div>

<div id="canvas-wrapper">
  <!-- 第一頁 -->
  <div class="a4-page" id="page-1">
    <div class="header-wrapper"><img class="header-img" src="banner.jpg"></div>
    <div class="paper-content" id="main-content-1">
      <div class="doc-title" id="show-title"></div>
      <div class="doc-recipient" id="show-recipient"></div>
      <div id="body-p1" class="body-container"></div>
      <div id="footer-p1"></div> <!-- 存放此致和署名 -->
    </div>
  </div>

  <!-- 第二頁 -->
  <div class="a4-page" id="page-2">
    <div class="header-wrapper"><img class="header-img" src="banner.jpg"></div>
    <div class="paper-content">
      <div id="body-p2" class="body-container"></div>
      <div id="footer-p2"></div>
    </div>
  </div>
</div>

<!-- 此致、署名、日期 模塊模板 (隱藏) -->
<div id="closing-template" style="display:none;">
    <div class="doc-salutation" id="show-salutation"></div>
    <div class="signature-container">
      <img class="doc-seal" src="shizi.png">
      <div class="sig-name" id="show-name"></div>
      <div class="sig-date" id="show-date"></div>
    </div>
</div>

<div id="result-container">
  <div class="seal-control-panel">
    <h3>第一步：檢查預覽</h3>
    <div style="display:flex; gap:10px; justify-content:center;">
        <input type="password" id="seal-pw" placeholder="輸入蓋章密碼" style="width:200px;">
        <button onclick="applySealAndRegen()" style="padding:10px 20px; background:#c00; color:white; border:none; border-radius:4px; cursor:pointer;">加蓋公章</button>
    </div>
  </div>
  <h3 id="result-status-text">預覽生成中...</h3>
  <img id="result-image">
</div>

<script>
function setCurrentDate() {
    const now = new Date();
    document.getElementById('input-date').value = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日`;
}

async function generatePreview() {
    // 1. 重置狀態
    const bodyP1 = document.getElementById('body-p1');
    const bodyP2 = document.getElementById('body-p2');
    const footerP1 = document.getElementById('footer-p1');
    const footerP2 = document.getElementById('footer-p2');
    const page2 = document.getElementById('page-2');
    
    bodyP1.innerHTML = "";
    bodyP2.innerHTML = "";
    footerP1.innerHTML = "";
    footerP2.innerHTML = "";
    page2.style.display = "none";

    // 2. 填充基本信息
    document.getElementById('show-title').innerText = document.getElementById('input-title').value;
    const rec = document.getElementById('input-recipient').value;
    document.getElementById('show-recipient').innerText = rec ? rec + "：" : "";
    
    // 3. 分段填充正文並檢測高度
    const fullText = document.getElementById('input-content').value;
    const paragraphs = fullText.split('\n');
    const maxHeight = 920; // 第一頁正文容納的安全高度
    
    let targetBody = bodyP1;
    let targetFooter = footerP1;
    let overflowed = false;

    for (let pText of paragraphs) {
        if (!pText.trim() && pText !== "") continue; 
        
        const pElem = document.createElement('div');
        pElem.style.marginBottom = "10px";
        pElem.innerText = pText;
        
        targetBody.appendChild(pElem);

        // 檢查高度是否溢出
        if (!overflowed && bodyP1.offsetTop + bodyP1.offsetHeight > maxHeight) {
            overflowed = true;
            page2.style.display = "flex";
            targetBody = bodyP2;
            targetFooter = footerP2;
            // 將剛才那個溢出的段落移到第二頁
            targetBody.appendChild(pElem);
        }
    }

    // 4. 填充此致、署名、日期
    const template = document.getElementById('closing-template').cloneNode(true);
    template.style.display = "block";
    template.querySelector('#show-salutation').innerText = document.getElementById('input-salutation').value;
    template.querySelector('#show-name').innerText = document.getElementById('input-name').value;
    template.querySelector('#show-date').innerText = document.getElementById('input-date').value;
    
    // 檢查如果加上落款後第一頁是否會溢出
    targetFooter.appendChild(template);
    if (!overflowed && (bodyP1.offsetTop + bodyP1.offsetHeight + footerP1.offsetHeight) > 950) {
        page2.style.display = "flex";
        footerP2.appendChild(template);
    }

    // 5. 截圖
    setTimeout(async () => {
        await captureCanvas("預覽圖片 (未蓋章)");
        document.getElementById('result-container').style.display = "block";
        document.getElementById('result-container').scrollIntoView({ behavior: 'smooth' });
        logToGAS();
    }, 300);
}

async function applySealAndRegen() {
    if (document.getElementById('seal-pw').value === "8888") {
        document.querySelectorAll('.doc-seal').forEach(s => s.style.display = "block");
        await captureCanvas("正式公文 (已蓋章)");
        alert("公章已加蓋！");
    } else {
        alert("密碼錯誤。");
    }
}

async function captureCanvas(statusText) {
    const wrapper = document.querySelector("#canvas-wrapper");
    const isTwoPages = document.getElementById('page-2').style.display === "flex";
    const totalHeight = isTwoPages ? 2246 : 1123;

    const canvas = await html2canvas(wrapper, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#e0e0e0",
        height: totalHeight
    });
    const img = document.getElementById('result-image');
    img.src = canvas.toDataURL("image/png");
    document.getElementById('result-status-text').innerText = "當前為：" + statusText;
}

function logToGAS() {
    const gas_url = "https://script.google.com/macros/s/AKfycbwRu5P74s_0LMbIB8u6qo04bX-NGGsGa9l2pc32xz4o16DgDq7RxIYXAGlfTkqbzO_8/exec"; 
    fetch(gas_url, {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify({ 
          title: document.getElementById('input-title').value, 
          recipient: document.getElementById('input-recipient').value, 
          user: document.getElementById('input-name').value, 
          content: document.getElementById('input-content').value 
      })
    });
}
</script>
</body>
</html>
