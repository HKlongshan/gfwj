<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>僑港順德龍山同鄉會入會申請</title>
  <script>
    // SignaturePad 庫 (保持原樣)
    !function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).SignaturePad=e()}(this,(function(){"use strict";class t{constructor(t,e,i,s){if(isNaN(t)||isNaN(e))throw new Error(`Point is invalid: (${t}, ${e})`);this.x=+t,this.y=+e,this.pressure=i||0,this.time=s||Date.now()}distanceTo(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))}equals(t){return this.x===t.x&&this.y===t.y&&this.pressure===t.pressure&&this.time===t.time}velocityFrom(t){return this.time!==t.time?this.distanceTo(t)/(this.time-t.time):0}}class e{static fromPoints(t,i){const s=this.calculateControlPoints(t[0],t[1],t[2]).c2,n=this.calculateControlPoints(t[1],t[2],t[3]).c1;return new e(t[1],s,n,t[2],i.start,i.end)}static calculateControlPoints(e,i,s){const n=e.x-i.x,o=e.y-i.y,h=i.x-s.x,r=i.y-s.y,a=(e.x+i.x)/2,c=(e.y+i.y)/2,d=(i.x+s.x)/2,l=(i.y+s.y)/2,u=Math.sqrt(n*n+o*o),v=Math.sqrt(h*h+r*r),_=v/(u+v),p=d+(a-d)*_,m=l+(c-l)*_,g=i.x-p,w=i.y-m;return{c1:new t(a+g,c+w),c2:new t(d+g,l+w)}}constructor(t,e,i,s,n,o){this.startPoint=t,this.control2=e,this.control1=i,this.endPoint=s,this.startWidth=n,this.endWidth=o}length(){let t,e,i=0;for(let s=0;s<=10;s+=1){const n=s/10,o=this.point(n,this.startPoint.x,this.control1.x,this.control2.x,this.endPoint.x),h=this.point(n,this.startPoint.y,this.control1.y,this.control2.y,this.endPoint.y);if(s>0){const s=o-t,n=h-e;i+=Math.sqrt(s*s+n*n)}t=o,e=h}return i}point(t,e,i,s,n){return e*(1-t)*(1-t)*(1-t)+3*i*(1-t)*(1-t)*t+3*s*(1-t)*t*t+n*t*t*t}}class i{constructor(){try{this._et=new EventTarget}catch(t){this._et=document}}addEventListener(t,e,i){this._et.addEventListener(t,e,i)}dispatchEvent(t){return this._et.dispatchEvent(t)}removeEventListener(t,e,i){this._et.removeEventListener(t,e,i)}}class s extends i{constructor(t,e={}){super(),this.canvas=t,this._drawingStroke=!1,this._isEmpty=!0,this._lastPoints=[],this._data=[],this._lastVelocity=0,this._lastWidth=0,this._handleMouseDown=t=>{1===t.buttons&&this._strokeBegin(t)},this._handleMouseMove=t=>{this._strokeMoveUpdate(t)},this._handleMouseUp=t=>{1===t.buttons&&this._strokeEnd(t)},this._handleTouchStart=t=>{if(t.cancelable&&t.preventDefault(),1===t.targetTouches.length){const e=t.changedTouches[0];this._strokeBegin(e)}},this._handleTouchMove=t=>{t.cancelable&&t.preventDefault();const e=t.targetTouches[0];this._strokeMoveUpdate(e)},this._handleTouchEnd=t=>{if(t.target===this.canvas){t.cancelable&&t.preventDefault();const e=t.changedTouches[0];this._strokeEnd(e)}},this._handlePointerStart=t=>{t.preventDefault(),this._strokeBegin(t)},this._handlePointerMove=t=>{this._strokeMoveUpdate(t)},this._handlePointerEnd=t=>{this._drawingStroke&&(t.preventDefault(),this._strokeEnd(t))},this.velocityFilterWeight=e.velocityFilterWeight||.7,this.minWidth=e.minWidth||.5,this.maxWidth=e.maxWidth||2.5,this.throttle="throttle"in e?e.throttle:16,this.minDistance="minDistance"in e?e.minDistance:5,this.dotSize=e.dotSize||0,this.penColor=e.penColor||"black",this.backgroundColor=e.backgroundColor||"rgba(0,0,0,0)",this.compositeOperation=e.compositeOperation||"source-over",this._strokeMoveUpdate=this.throttle?function(t,e=250){let i,s,n,o=0,h=null;const r=()=>{o=Date.now(),h=null,i=t.apply(s,n),h||(s=null,n=[])};return function(...a){const c=Date.now(),d=e-(c-o);return s=this,n=a,d<=0||d>e?(h&&(clearTimeout(h),h=null),o=c,i=t.apply(s,n),h||(s=null,n=[])):h||(h=window.setTimeout(r,d)),i}}(s.prototype._strokeUpdate,this.throttle):s.prototype._strokeUpdate,this._ctx=t.getContext("2d"),this.clear(),this.on()}clear(){const{_ctx:t,canvas:e}=this;t.fillStyle=this.backgroundColor,t.clearRect(0,0,e.width,e.height),t.fillRect(0,0,e.width,e.height),this._data=[],this._reset(this._getPointGroupOptions()),this._isEmpty=!0}toDataURL(t="image/png",e){return this.canvas.toDataURL(t,e)}on(){this.canvas.style.touchAction="none",this.canvas.style.userSelect="none";window.PointerEvent?this._handlePointerEvents():(this._handleMouseEvents(),"ontouchstart"in window&&this._handleTouchEvents())}isEmpty(){return this._isEmpty}_strokeBegin(t){if(!this.dispatchEvent(new CustomEvent("beginStroke",{detail:t,cancelable:!0})))return;this._drawingStroke=!0;const e=this._getPointGroupOptions(),i=Object.assign(Object.assign({},e),{points:[]});this._data.push(i),this._reset(e),this._strokeUpdate(t)}_strokeUpdate(t){if(!this._drawingStroke)return;const n=this._createPoint(t.clientX,t.clientY);const o=this._data[this._data.length-1],h=o.points,r=h.length>0&&h[h.length-1],a=!!r&&n.distanceTo(r)<=this.minDistance;if(!r||!a){const r_point=this._addPoint(n,this._getPointGroupOptions(o));r?r_point&&this._drawCurve(r_point,o):this._drawDot(n,o),h.push({time:n.time,x:n.x,y:n.y})}}_strokeEnd(t){this._drawingStroke&&(this._strokeUpdate(t),this._drawingStroke=!1)}_handlePointerEvents(){this.canvas.addEventListener("pointerdown",this._handlePointerStart),this.canvas.addEventListener("pointermove",this._handlePointerMove),document.addEventListener("pointerup",this._handlePointerEnd)}_handleMouseEvents(){this.canvas.addEventListener("mousedown",this._handleMouseDown),this.canvas.addEventListener("mousemove",this._handleMouseMove),document.addEventListener("mouseup",this._handleMouseUp)}_handleTouchEvents(){this.canvas.addEventListener("touchstart",this._handleTouchStart),this.canvas.addEventListener("touchmove",this._handleTouchMove),this.canvas.addEventListener("touchend",this._handleTouchEnd)}_reset(t){this._lastPoints=[],this._lastVelocity=0,this._lastWidth=(t.minWidth+t.maxWidth)/2,this._ctx.fillStyle=t.penColor}_createPoint(e,i){const n=this.canvas.getBoundingClientRect();return new t(e-n.left,i-n.top,0,Date.now())}_addPoint(t,i){const{_lastPoints:s}=this;s.push(t);if(s.length>2){if(3===s.length)s.unshift(s[0]);const t=this._calculateCurveWidths(s[1],s[2],i),n=e.fromPoints(s,t);return s.shift(),n}return null}_calculateCurveWidths(t,e,i){const s=i.velocityFilterWeight*e.velocityFrom(t)+(1-i.velocityFilterWeight)*this._lastVelocity,n=Math.max(i.maxWidth/(s+1),i.minWidth);const o={end:n,start:this._lastWidth};return this._lastVelocity=s,this._lastWidth=n,o}_drawCurve(t,e){const i=this._ctx;i.beginPath(),i.fillStyle=e.penColor;const n=2*Math.ceil(t.length());for(let i=0;i<n;i++){const o=i/n,h=o*o,r=h*o,a=1-o,c=a*a,d=c*a;let l=d*t.startPoint.x+3*c*o*t.control1.x+3*a*h*t.control2.x+r*t.endPoint.x;let u=d*t.startPoint.y+3*c*o*t.control1.y+3*a*h*t.control2.y+r*t.endPoint.y;i.moveTo(l,u),i.arc(l,u,t.startWidth+r*(t.endWidth-t.startWidth),0,2*Math.PI,!1)}i.fill(),this._isEmpty=!1}_drawDot(t,e){const i=this._ctx;i.beginPath(),i.arc(t.x,t.y,(e.minWidth+e.maxWidth)/2,0,2*Math.PI,!1),i.fillStyle=e.penColor,i.fill(),this._isEmpty=!1}_getPointGroupOptions(t){return{penColor:this.penColor,minWidth:this.minWidth,maxWidth:this.maxWidth,velocityFilterWeight:this.velocityFilterWeight}}}return s}));
  </script>
  
  <style>
    body { background-color: #fcc7bd; font-family: 'Roboto', 'Google Sans', Helvetica, Arial, sans-serif; padding: 20px; margin: 0; overflow-x: hidden; }
    .container { max-width: 960px; width: 100%; margin: 0 auto; background: white; border-radius: 8px; border-top: 15px solid #f55f41; padding: 30px; box-sizing: border-box; box-shadow: 0 1px 4px rgba(0,0,0,0.3); }
    #header-image { width: 100%; height: auto; display: block; margin-bottom: 30px; border-radius: 4px; border: 1px solid #e0e0e0; }
    h2 { color: #202124; font-size: 32px; margin: 20px 0; font-weight: 500; text-align: center; }
    .description { font-size: 18px; color: #202124; margin-bottom: 30px; line-height: 1.6; text-align: center; }
    .form-group { margin-bottom: 30px; padding: 20px; border: 1px solid #dadce0; border-radius: 8px; background-color: #fff; transition: all 0.3s; }
    label { font-size: 22px; display: block; margin-bottom: 10px; font-weight: 500;}
    .required-label:after { content: " *"; color: #d93025; font-size: 24px; }
    input[type="text"], input[type="tel"], input[type="email"], input[type="number"] { width: 100%; padding: 10px 0; border: none; border-bottom: 1px dotted #999; font-size: 20px; outline:none; }
    .radio-group label, .checkbox-group label { font-size: 20px; margin-bottom: 15px; display: flex; align-items: center; cursor: pointer; width: 100%; font-weight: normal;}
    .radio-group input, .checkbox-group input { margin-right: 15px; width: 26px; height: 26px; accent-color: #9b3d2a; flex-shrink: 0;}
    .date-input-wrapper { display: flex; justify-content: space-between; align-items: center; }
    .date-box { text-align: center; width: 30%; }
    .date-box input { width: 100%; text-align: center; border: none; border-bottom: 1px solid #999; font-size: 20px; padding: 5px 0; }
    .signature-pad-wrapper { border: 2px solid #dadce0; border-radius: 4px; background-color: #fffaf0; position: relative; height: 250px; width: 100%; }
    canvas { width: 100%; height: 100%; display: block; touch-action: none; }
    button.submit-btn { width: 100%; max-width: 300px; padding: 18px; background-color: #9b3d2a; color: white; border: none; border-radius: 8px; font-size: 24px; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
    .clear-btn { color: #9b3d2a; border: none; background: none; font-weight: bold; padding: 10px 0; font-size: 18px; cursor: pointer; float: right; }
    .fee-notice { font-size: 20px; font-weight: bold; margin: 30px 0; line-height: 1.4; color: #b22222; }
    @keyframes flash-red { 0% { border-color: #dadce0; background-color: #fff; } 50% { border-color: #ff0000; background-color: #ffeeee; } 100% { border-color: #dadce0; background-color: #fff; } }
    .flash-error { animation: flash-red 0.5s 3; border: 2px solid red !important; }
  </style>
</head>
<body>

<div class="container">
 <img id="header-image" src="banner.jpg" alt="僑港順德龍山同鄉會">
  
 <h2>僑港順德龍山同鄉會</h2>
  <h2>入會申請表格</h2>
    <div class="description">承蒙您的關注與支持，實乃本會之幸。謹向您致以最誠摯的感謝。<br>
    感謝您一直以來對僑港順德龍山同鄉會的呵護與推動，也盼能在您的見證下，開啟與同鄉攜手同行的新篇。<br><br>
    <span style="color: red;">*</span> 為必填項目</div>
  
  <form id="memberForm">
    <input type="hidden" name="member_id" id="member_id_hidden">

    <div class="form-group"><label>介紹人</label><input type="text" name="referrer"></div>
    <div class="form-group"><label class="required-label">中文姓名</label><input type="text" name="name_zh" required></div>
    <div class="form-group"><label>英文姓名</label><input type="text" name="name_en"></div>
    <div class="form-group"><label class="required-label">性別</label>
      <div class="radio-group">
        <label><input type="radio" name="gender" value="男" required> 男</label>
        <label><input type="radio" name="gender" value="女"> 女</label>
      </div>
    </div>
    <div class="form-group"><label class="required-label">年齡</label><input type="number" name="age" required></div>
    <div class="form-group">
      <label class="required-label">出生日期 (年/月/日)</label>
      <div class="date-input-wrapper">
        <div class="date-box"><input type="number" id="dob_y" placeholder="YYYY" required><div style="font-size:12px;">年</div></div>
        <div class="date-box"><input type="number" id="dob_m" placeholder="MM" required><div style="font-size:12px;">月</div></div>
        <div class="date-box"><input type="number" id="dob_d" placeholder="DD" required><div style="font-size:12px;">日</div></div>
      </div>
      <input type="hidden" name="dob" id="dob_hidden">
    </div>
    <div class="form-group"><label class="required-label">身份證/護照號碼</label><input type="text" name="id_passport" required></div>
    <div class="form-group"><label class="required-label">籍貫/國籍</label><input type="text" name="native_country" required></div>
    <div class="form-group"><label>職業</label><input type="text" name="occupation"></div>
    <div class="form-group"><label>婚姻狀況</label>
      <div class="radio-group">
        <label><input type="radio" name="marital_status" value="未婚/單身"> 未婚/單身</label>
        <label><input type="radio" name="marital_status" value="已婚"> 已婚</label>
        <label><input type="radio" name="marital_status" value="離婚"> 離婚</label>
        <label><input type="radio" name="marital_status" value="分居"> 分居</label>
        <label><input type="radio" name="marital_status" value="喪偶"> 喪偶</label>
      </div>
    </div>
    <div class="form-group"><label class="required-label">地址</label><input type="text" name="address" required></div>
    <div class="form-group"><label class="required-label">電話</label><input type="tel" name="phone" required></div>
    <div class="form-group"><label>電郵</label><input type="email" name="email"></div>
    <div class="form-group"><label>通訊軟體偏好</label>
      <div class="radio-group">
        <label><input type="radio" name="comm_app" value="WhatsApp"> WhatsApp</label>
        <label><input type="radio" name="comm_app" value="WeChat"> WeChat</label>
        <label><input type="radio" name="comm_app" value="僅短信"> 僅短信 (SMS)</label>
      </div>
    </div>
   
    <div class="form-group"><label class="required-label">是否已登記為選民</label>
      <div class="radio-group">
        <label><input type="radio" name="is_voter" value="是" required> 是</label>
        <label><input type="radio" name="is_voter" value="否"> 否</label>
      </div>
    </div>
    
    <div class="fee-notice">永遠入會會費100港元，<br>請前往秘書處繳付會費激活會員資格。<br></div>
    <div class="fee-notice">如獲接納為僑港順德龍山同鄉會會員，本人願意接受及遵守貴會會章和所頒布的一切條款與通告。<br>
    若本人退出貴會，本人願意交還會員證書及即時繳還一切欠付貴會之有關費用。</div>
    
    <div class="form-group">
      <div class="checkbox-group">
        <label class="required-label"><input type="checkbox" name="declaration" required> 確認填寫資料屬實並同意入會條款</label>
      </div>
    </div>

    <div class="form-group" id="signature-group">
      <label class="required-label">本人簽署</label>
      <div class="signature-pad-wrapper"><canvas id="sig-canvas"></canvas></div>
      <button type="button" class="clear-btn" onclick="signaturePad.clear()">清除重寫</button>
      <input type="hidden" name="signature" id="signature">
    </div>

    <div style="display: flex; flex-direction: column; align-items: center; padding-bottom: 50px;">
        <button type="button" class="submit-btn" id="submitBtn" onclick="submitForm()">提交申請</button>
        <div id="msg" style="margin-top: 15px; font-weight: bold; color: #666;"></div>
    </div>
  </form>
</div>

<script>
  const canvas = document.getElementById('sig-canvas');
  const signaturePad = new SignaturePad(canvas);
  
  function resizeCanvas() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    canvas.getContext("2d").scale(ratio, ratio);
    signaturePad.clear();
  }
  window.addEventListener("resize", resizeCanvas);
  setTimeout(resizeCanvas, 500);

  function handleError(element, message) {
    alert(message);
    const group = element.closest('.form-group');
    if (group) {
        group.scrollIntoView({ behavior: 'smooth', block: 'center' });
        group.classList.add('flash-error');
        setTimeout(() => group.classList.remove('flash-error'), 3000);
    }
    element.focus();
  }

  async function submitForm() {
    const form = document.getElementById('memberForm');
    const msg = document.getElementById('msg');
    const btn = document.getElementById('submitBtn');

    // 必填項驗證
    const requiredInputs = form.querySelectorAll('[required]');
    for (let input of requiredInputs) {
        let isValid = true;
        let fieldName = input.closest('.form-group').querySelector('label').innerText.replace(' *', '');

        if (input.type === 'radio') {
            const radioGroup = form.querySelectorAll(`input[name="${input.name}"]:checked`);
            if (radioGroup.length === 0) isValid = false;
        } else if (input.type === 'checkbox') {
            if (!input.checked) isValid = false;
        } else {
            if (!input.value.trim()) isValid = false;
        }

        if (!isValid) {
            handleError(input, `請填寫必填項目：${fieldName}`);
            return;
        }
    }

    // 驗證出生日期
    const y = document.getElementById('dob_y').value;
    const m = document.getElementById('dob_m').value;
    const d = document.getElementById('dob_d').value;
    if(!y || !m || !d) { 
        handleError(document.getElementById('dob_y'), "請完整填寫出生日期（年、月、日）");
        return; 
    }
    document.getElementById('dob_hidden').value = `${y}/${m}/${d}`;

    // 驗證簽名
    if(signaturePad.isEmpty()) { 
        handleError(canvas, "請在簽名區完成簽署");
        return;
    }
    document.getElementById('signature').value = signaturePad.toDataURL();

    // 開始提交
    btn.disabled = true;
    msg.innerText = "正在同步數據到 Google 及伺服器...";

    // 生成會員號碼
    const now = new Date();
    const dateStr = now.getFullYear() + String(now.getMonth()+1).padStart(2,'0') + String(now.getDate()).padStart(2,'0');
    const randomSuffix = Math.floor(1000 + Math.random() * 9000);
    const memberId = "LS" + dateStr + randomSuffix;
    document.getElementById('member_id_hidden').value = memberId;

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // --- 雙路並行提交 ---
    const webAppUrl = "https://script.google.com/macros/s/AKfycbzwYvy4t391KjK5CX8edd-pTCifijzXjoLFLzK8534JCl_SwrFrhqJD-a8zf-PEy_lM/exec";
    const serverUrl = "https://longshan.xin/submit";

    try {
        // 1. 向 Google 發送 (不等待結果，防止牆的問題導致超時)
        fetch(webAppUrl, { 
            method: 'POST', 
            body: new Blob([JSON.stringify(data)], {type: 'text/plain'}), 
            mode: 'no-cors' 
        }).catch(e => console.log("Google Sync Failed (Background)"));

        // 2. 向您的阿里雲伺服器發送 (主要判定依據)
        const response = await fetch(serverUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        
        if (result.success) {
            alert("歡迎加入龍山同鄉會\n\n您的臨時會員號碼為：" + memberId + "\n\n申請已提交成功，請及時前往秘書處繳費激活會員身份。");
            form.reset();
            signaturePad.clear();
            msg.innerText = "提交成功。";
        } else {
            throw new Error(result.message || "伺服器返回錯誤");
        }
    } catch (e) {
        console.error("Submission Error:", e);
        alert("提交出現異常，但已嘗試同步至備份系統。如有疑問請聯絡秘書處。");
        msg.innerText = "提交出現問題。";
    } finally {
        btn.disabled = false;
    }
  }
</script>
</body>
</html>
